<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<title>Alterar senha</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">

<style>
body { background: linear-gradient(135deg, #f4f6f9, #e9ecef); }
.fade-in { animation: fadeIn 0.6s ease-in-out; }
@keyframes fadeIn { from { opacity:0; transform: translateY(20px); } to { opacity:1; transform: translateY(0); } }
.criterio { font-size:0.85rem; transition: all 0.3s; }
.criterio.valid { color:green; font-weight:600; }
.criterio.invalid { color:red; font-weight:400; }
.progress { height:10px; border-radius:5px; overflow:hidden; margin-top:5px; }
.progress-bar { transition: width 0.4s, background-color 0.4s; }
</style>
</head>
<body>

<div class="container vh-100 d-flex align-items-center justify-content-center">
<div class="col-md-6 col-lg-4 fade-in">
<div class="card shadow-lg border-0 rounded-4">
<div class="card-header bg-danger text-white text-center rounded-top-4 py-3">
<h5 class="mb-0 fw-semibold"><i class="bi bi-shield-lock-fill"></i> Alterar senha</h5>
</div>
<div class="card-body p-4">
<form method="post" id="formSenha" novalidate>
{% csrf_token %}

<div class="form-floating mb-3">
<input type="text" class="form-control" id="cpf" name="cpf" placeholder="CPF" required>
<label for="cpf">CPF</label>
</div>

<div class="form-floating mb-3 position-relative">
<input type="password" class="form-control" id="senha" name="senha" placeholder="Nova senha" required>
<label for="senha">Nova senha</label>
<i class="bi bi-eye-fill position-absolute top-50 end-0 translate-middle-y me-3 text-muted" style="cursor:pointer" onclick="toggleSenha('senha', this)"></i>

<div class="progress">
<div id="senhaForca" class="progress-bar" role="progressbar" style="width:0%;"></div>
</div>
<small id="senhaTexto" class="text-muted mt-1 d-block"></small>

<ul class="mt-2 mb-0 list-unstyled">
<li id="critLen" class="criterio invalid">❌ Mínimo 8 caracteres</li>
<li id="critLower" class="criterio invalid">❌ Letra minúscula</li>
<li id="critUpper" class="criterio invalid">❌ Letra maiúscula</li>
<li id="critNumber" class="criterio invalid">❌ Número</li>
<li id="critSymbol" class="criterio invalid">❌ Símbolo especial</li>
<li id="critSeq" class="criterio valid">✅ Sem sequência numérica</li>
</ul>
</div>

<div class="form-floating mb-4 position-relative">
<input type="password" class="form-control" id="confirmar" name="confirmar" placeholder="Confirmar senha" required>
<label for="confirmar">Confirmar senha</label>
<i class="bi bi-eye-fill position-absolute top-50 end-0 translate-middle-y me-3 text-muted" style="cursor:pointer" onclick="toggleSenha('confirmar', this)"></i>
</div>

<button type="submit" class="btn btn-danger w-100 py-2 fw-semibold">
<i class="bi bi-check-circle-fill"></i> Salvar nova senha
</button>
<a href="{% url 'usuario_list' %}" class="btn btn-outline-secondary w-100 mt-2">
<i class="bi bi-arrow-left"></i> Voltar para lista
</a>
</form>
</div></div></div></div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
function toggleSenha(id, icon){
    const campo = document.getElementById(id);
    if(campo.type==="password"){ campo.type="text"; icon.classList.replace("bi-eye-fill","bi-eye-slash-fill"); }
    else{ campo.type="password"; icon.classList.replace("bi-eye-slash-fill","bi-eye-fill"); }
}

const senhaInput = document.getElementById('senha');
const confirmarInput = document.getElementById('confirmar');
const barraForca = document.getElementById('senhaForca');
const textoForca = document.getElementById('senhaTexto');
const form = document.getElementById('formSenha');

const critLen = document.getElementById('critLen');
const critLower = document.getElementById('critLower');
const critUpper = document.getElementById('critUpper');
const critNumber = document.getElementById('critNumber');
const critSymbol = document.getElementById('critSymbol');
const critSeq = document.getElementById('critSeq');

function temSequenciaNumerica(senha){
    for(let i=0;i<=senha.length-3;i++){
        const seq = senha.substring(i,i+3);
        if(/^\d{3,}$/.test(seq)){
            let numeros = seq.split('').map(Number);
            if(numeros[1] === numeros[0]+1 && numeros[2] === numeros[1]+1) return true;
            if(numeros[1] === numeros[0]-1 && numeros[2] === numeros[1]-1) return true;
        }
    }
    return false;
}

senhaInput.addEventListener('input', function(){
    const senha = senhaInput.value;
    const hasLen = senha.length>=8;
    const hasLower = /[a-z]/.test(senha);
    const hasUpper = /[A-Z]/.test(senha);
    const hasNumber = /\d/.test(senha);
    const hasSymbol = /[\W_]/.test(senha);
    const semSeq = !temSequenciaNumerica(senha);

    let pontos = [hasLen,hasLower,hasUpper,hasNumber,hasSymbol,semSeq].filter(Boolean).length;
    barraForca.style.width = `${(pontos/6)*100}%`;
    if(pontos<=2) barraForca.style.backgroundColor="#dc3545";
    else if(pontos<=4) barraForca.style.backgroundColor="#ffc107";
    else barraForca.style.backgroundColor="#198754";

    textoForca.textContent = pontos<3?"Fraca":pontos<5?"Média":"Forte";

    critLen.className = hasLen?'criterio valid':'criterio invalid';
    critLen.textContent = (hasLen?'✅':'❌')+" Mínimo 8 caracteres";

    critLower.className = hasLower?'criterio valid':'criterio invalid';
    critLower.textContent = (hasLower?'✅':'❌')+" Letra minúscula";

    critUpper.className = hasUpper?'criterio valid':'criterio invalid';
    critUpper.textContent = (hasUpper?'✅':'❌')+" Letra maiúscula";

    critNumber.className = hasNumber?'criterio valid':'criterio invalid';
    critNumber.textContent = (hasNumber?'✅':'❌')+" Número";

    critSymbol.className = hasSymbol?'criterio valid':'criterio invalid';
    critSymbol.textContent = (hasSymbol?'✅':'❌')+" Símbolo especial";

    critSeq.className = semSeq?'criterio valid':'criterio invalid';
    critSeq.textContent = semSeq?'✅ Sem sequência numérica':'❌ Sem sequência numérica';
});

form.addEventListener('submit', function(e){
    const senha = senhaInput.value;
    const confirmar = confirmarInput.value;
    const regexForte = /^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[\W_]).{8,}$/;

    if(!regexForte.test(senha)){
        e.preventDefault();
        alert("A senha deve ter pelo menos 8 caracteres, incluindo letras maiúsculas, minúsculas, números e símbolos.");
        senhaInput.focus();
        return false;
    }
    if(temSequenciaNumerica(senha)){
        e.preventDefault();
        alert("A senha não pode conter sequências numéricas como 123 ou 987.");
        senhaInput.focus();
        return false;
    }
    if(senha !== confirmar){
        e.preventDefault();
        alert("A confirmação da senha não coincide.");
        confirmarInput.focus();
        return false;
    }
});
</script>
</body>
</html>
