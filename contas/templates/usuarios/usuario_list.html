<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<title>Usuários do Sistema - PT Saúde</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">

<style>
body {
    background-color: #f4f6f9;
    font-family: 'Segoe UI', Arial, sans-serif;
}

.table thead {
    background-color: #e31b23;
    color: white;
}

.table td, .table th {
    vertical-align: middle;
}

.badge-cpf {
    background-color: #f1f1f1;
    border: 1px solid #ddd;
    font-weight: 500;
    font-size: 0.85rem;
    padding: 6px 10px;
    white-space: nowrap;
    display: inline-block;
    min-width: 110px;
    text-align: center;
}


</style>
</head>

<body>

<div class="container mt-5">

    <!-- TOPO -->
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h3 class="fw-bold mb-0">
            <i class="bi bi-people-fill me-2 text-danger"></i>
            Usuários do Sistema
        </h3>

        <a href="{% url 'usuario_create' %}" class="btn btn-danger">
            <i class="bi bi-person-plus-fill me-1"></i> Novo Usuário
        </a>
    </div>

   <form method="get" class="row g-2 mb-3">
    <div class="col-md-8">
        <input type="text"
               name="q"
               value="{{ termo }}"
               class="form-control"
               placeholder="Buscar por usuário ou CPF">
    </div>

    <div class="col-md-2 d-grid">
        <button class="btn btn-danger">
            <i class="bi bi-search"></i> Buscar
        </button>
    </div>

    <div class="col-md-2 d-grid">
        <a href="{% url 'usuario_list' %}" class="btn btn-outline-secondary">
            <i class="bi bi-x-circle"></i> Limpar
        </a>
    </div>
</form>


    <!-- STATUS -->
    <div class="d-flex justify-content-between align-items-center mb-2 text-muted small">
        <div>
            Total de usuários: <strong>{{ total_usuarios }}</strong>
            {% if termo %}
                <span class="ms-2">| Filtro: "<strong>{{ termo }}</strong>"</span>
            {% endif %}
        </div>

        {% if usuarios %}
        <div>
            Mostrando {{ usuarios.start_index }}–{{ usuarios.end_index }}
            de {{ usuarios.paginator.count }}
        </div>
        {% endif %}
    </div>

    <!-- CARD -->
    <div class="card shadow-sm border-0 rounded-4">
        <div class="card-body">

            {% if usuarios %}
            <div class="table-responsive">
                <table class="table table-hover align-middle mb-0">
                    <thead>
                        <tr>
                            <th>Usuário</th>
                            <th>Nome</th>
                            <th>E-mail</th>
                            <th>CPF</th>
                            <th class="text-center">Ações</th>
                        </tr>
                    </thead>

                    <tbody>
                        {% for u in usuarios %}
                        <tr>
                            <td class="fw-semibold">{{ u.username }}</td>

                            <td>{{ u.get_full_name|default:"—" }}</td>

                            <td>{{ u.email|default:"—" }}</td>

                            <td>
    {% if u.profile.cpf %}
        <span class="badge-cpf">
            {{ u.profile.cpf }}
        </span>
    {% else %}
        —
    {% endif %}
</td>


                            <td class="text-center text-nowrap">
                                <a href="{% url 'usuario_update' u.id %}"
                                   class="btn btn-sm btn-warning me-1"
                                   title="Editar">
                                    <i class="bi bi-pencil-square"></i>
                                </a>

                                <a href="{% url 'usuario_delete' u.id %}"
                                   class="btn btn-sm btn-danger"
                                   title="Excluir"
                                   onclick="return confirm('Tem certeza que deseja excluir este usuário?');">
                                    <i class="bi bi-trash"></i>
                                </a>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <!-- PAGINAÇÃO -->
            {% if usuarios.has_other_pages %}
            <nav class="mt-4">
                <ul class="pagination justify-content-center">

                    {% if usuarios.has_previous %}
                    <li class="page-item">
                        <a class="page-link"
                           href="?q={{ termo }}&page={{ usuarios.previous_page_number }}">
                           « Anterior
                        </a>
                    </li>
                    {% else %}
                    <li class="page-item disabled">
                        <span class="page-link">« Anterior</span>
                    </li>
                    {% endif %}

                    {% for num in usuarios.paginator.page_range %}
                        {% if usuarios.number == num %}
                            <li class="page-item active">
                                <span class="page-link">{{ num }}</span>
                            </li>
                        {% else %}
                            <li class="page-item">
                                <a class="page-link"
                                   href="?q={{ termo }}&page={{ num }}">
                                   {{ num }}
                                </a>
                            </li>
                        {% endif %}
                    {% endfor %}

                    {% if usuarios.has_next %}
                    <li class="page-item">
                        <a class="page-link"
                           href="?q={{ termo }}&page={{ usuarios.next_page_number }}">
                           Próxima »
                        </a>
                    </li>
                    {% else %}
                    <li class="page-item disabled">
                        <span class="page-link">Próxima »</span>
                    </li>
                    {% endif %}

                </ul>
            </nav>
            {% endif %}

            {% else %}
            <div class="text-center text-muted py-5">
                <i class="bi bi-info-circle fs-1"></i>
                <p class="mt-3">Nenhum usuário cadastrado.</p>
            </div>
            {% endif %}

        </div>
    </div>

    <!-- VOLTAR -->
    <div class="mt-4">
        <a href="{% url 'home' %}" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left"></i> Voltar para Home
        </a>
    </div>

</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>

<script>
document.addEventListener("DOMContentLoaded", function () {
    const input = document.querySelector("input[name='q']");

    if (!input) return;

    input.addEventListener("input", function () {
        let v = input.value.replace(/\D/g, "").slice(0, 11);

        v = v.replace(/(\d{3})(\d)/, "$1.$2");
        v = v.replace(/(\d{3})(\d)/, "$1.$2");
        v = v.replace(/(\d{3})(\d{1,2})$/, "$1-$2");

        input.value = v;
    });
});
</script>
